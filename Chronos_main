import SwiftUI
import Foundation
import EventKit
import UserNotifications

// MARK: - è¼”åŠ©å·¥å…· (Helpers)

extension Color {
    init(hex: String) {
        let hex = hex.trimmingCharacters(in: CharacterSet.alphanumerics.inverted)
        var int: UInt64 = 0
        Scanner(string: hex).scanHexInt64(&int)
        let a, r, g, b: UInt64
        switch hex.count {
        case 3: // RGB (12-bit)
            (a, r, g, b) = (255, (int >> 8) * 17, (int >> 4 & 0xF) * 17, (int & 0xF) * 17)
        case 6: // RGB (24-bit)
            (a, r, g, b) = (255, int >> 16, int >> 8 & 0xFF, int & 0xFF)
        case 8: // ARGB (32-bit)
            (a, r, g, b) = (int >> 24, int >> 16 & 0xFF, int >> 8 & 0xFF, int & 0xFF)
        default:
            // ä¿®æ­£: ç‚ºäº†å¯¦ç¾çœŸæ­£çš„ã€Œclearã€ï¼Œa, r, g, b æ‡‰ç‚º 0
            (a, r, g, b) = (0, 0, 0, 0) // Default to clear
        }
        
        self.init(
            .sRGB,
            red: Double(r) / 255,
            green: Double(g) / 255,
            blue:  Double(b) / 255,
            opacity: Double(a) / 255
        )
    }
    
    // é è¨­é¡è‰²ï¼Œç”¨æ–¼æˆå“¡ç®¡ç†
    static let memberColors: [Color] = [.indigo, .orange, .green, .teal, .purple, .pink, .blue, .yellow]
    static let memberHexes: [String] = ["#5C5CFF", "#FF9500", "#34C759", "#64D2FF", "#AF52DE", "#FF2D55", "#007AFF", "#FFCC00"]
}

// MARK: - è³‡æ–™æ¨¡å‹ (Data Model)

/// å®¶åº­æˆå“¡è³‡æ–™çµæ§‹ (æ–°å¢ colorHex)
struct Member: Identifiable, Codable, Hashable {
    var id = UUID()
    var name: String
    var colorHex: String // ç”¨æ–¼ UI æ¨™è¨˜çš„é¡è‰²
}

/// é ç´„è³‡æ–™çš„çµæ§‹ (ä¿ç•™é ç´„å°ˆå±¬è³‡è¨Š)
struct Appointment: Identifiable, Codable {
    var id = UUID()
    var name: String // é ç´„è€…å§“å/å®¶åº­æˆå“¡åç¨±
    var date: Date
    var service: String // æœå‹™é …ç›®ï¼Œå« Emoji
    var email: String?
    var phone: String?
    var amount: Double? // æ¶ˆè²»é‡‘é¡ (å¯é¸)
    var photoDescription: String?
    // åœ–ç‰‡æè¿°/å‚™è¨»
    var isPhotoAttached: Bool = false
    var extraServiceDetail: String?
    // å¦‚æœæœå‹™æ˜¯ã€Œå…¶ä»–ã€ï¼Œè¨˜éŒ„é¡å¤–è©³æƒ…
    
    var displayAmount: Double {
        return amount ?? 0.0
    }
}

/// æ—¥å¸¸äº¤æ˜“è³‡æ–™çµæ§‹ (æ–°å¢)
struct GeneralTransaction: Identifiable, Codable {
    var id = UUID()
    var date: Date
    var memberName: String // èª°çš„æ”¯å‡º/æ”¶å…¥
    var amount: Double
    var description: String
    var type: TransactionType
    
    enum TransactionType: String, Codable {
        case income = "æ”¶å…¥"
        case expense = "æ”¯å‡º"
    }
}


// MARK: - è¼”åŠ©è¦–åœ– (Helper Views)

struct CalendarGridView: View {
    let daysInMonth: [Date]
    let members: [Member]
    let getDailyTransactions: (Date) -> (totalExpense: Double, totalIncome: Double, expenseMembers: [String: Double])
    let dayTapped: (Date) -> Void
    
    let daysOfWeek = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"]
    let columns = Array(repeating: GridItem(.flexible()), count: 7)
    
    var body: some View {
        LazyVGrid(columns: columns, spacing: 5) {
            ForEach(daysOfWeek, id: \.self) { day in
                Text(day)
                    .font(.caption)
                    .fontWeight(.bold)
                    .foregroundColor(.secondary)
            }
            
            // å¡«è£œæœˆåˆçš„ç©ºç™½
            let firstDay = daysInMonth.first!
            let startOfWeek = Calendar.current.component(.weekday, from: firstDay) - 1
            ForEach(0..<startOfWeek, id: \.self) { _ in
                Spacer()
            }
            
            // æ—¥æœŸå–®å…ƒæ ¼
            ForEach(daysInMonth, id: \.self) { date in
                DayCellView(date: date, members: members, getDailyTransactions: getDailyTransactions)
                    .onTapGesture {
                        dayTapped(date)
                    }
            }
        }
    }
}

struct DayCellView: View {
    let date: Date
    let members: [Member]
    let getDailyTransactions: (Date) -> (totalExpense: Double, totalIncome: Double, expenseMembers: [String: Double])
    
    @State private var transactions: (totalExpense: Double, totalIncome: Double, expenseMembers: [String: Double]) = (0, 0, [:])
    
    var memberColors: [Color] {
        transactions.expenseMembers.keys
            .compactMap { name in
                members.first(where: { $0.name == name })
            }
            .map { Color(hex: $0.colorHex) }
            .prefix(3)
            .map { $0 } // å°‡ ArraySlice è½‰æ›ç‚º Array
    }
    var isToday: Bool {
        Calendar.current.isDateInToday(date)
    }

    var body: some View {
        VStack(spacing: 2) {
            Text(date, format: .dateTime.day())
                .font(.subheadline)
                .fontWeight(isToday ? .bold : .regular)
                .foregroundColor(isToday ? .white : .primary)
                .frame(maxWidth: .infinity)
                .background(isToday ? Color.indigo : Color.clear)
                .clipShape(Circle())

            // ç¸½æ”¯å‡º (é ç´„ + ä¸€èˆ¬)
            if transactions.totalExpense > 0 {
                HStack(spacing: 1) {
                    ForEach(memberColors.indices, id: \.self) { index in
                        Circle()
                            .fill(memberColors[index])
                            .frame(width: 4, height: 4)
                    }
                    Text("-\(transactions.totalExpense, specifier: "%.0f")")
                        .font(.caption2)
                        .foregroundColor(.red)
                        .minimumScaleFactor(0.6)
                        .lineLimit(1)
                }
            } else {
                 Spacer().frame(height: 14) // ä¿æŒé«˜åº¦ä¸€è‡´
            }
            
            // ç¸½æ”¶å…¥
            if transactions.totalIncome > 0 {
                Text("+\(transactions.totalIncome, specifier: "%.0f")")
                    .font(.caption2)
                    .foregroundColor(.green)
                    .minimumScaleFactor(0.6)
                    .lineLimit(1)
            } else {
                Spacer().frame(height: 14) // ä¿æŒé«˜åº¦ä¸€è‡´
            }
        }
        .padding(.vertical, 5)
        .frame(minHeight: 60)
        .background(Color.gray.opacity(Calendar.current.isDateInToday(date) ? 0.2 : 0.05))
        .cornerRadius(8)
        .onAppear {
            transactions = getDailyTransactions(date)
        }
    }
}

struct ProportionChart: View {
    let data: [(label: String, value: Double)]
    let total: Double
    
    private let colors: [Color] = [.indigo, .orange, .green, .teal, .purple, .pink, .blue, .yellow]
    
    var body: some View {
        VStack(alignment: .leading, spacing: 15) {
            ForEach(data.indices, id: \.self) { index in
                let item = data[index]
                let color = colors[index % colors.count]
                let percentage = item.value / total
           
                VStack(alignment: .leading, spacing: 4) {
                    HStack {
                        Text(item.label)
                            .font(.subheadline)
                        Spacer()
                        Text("$\(item.value, specifier: "%.0f") (\(percentage, specifier: "%.1f")%)")
                            .fontWeight(.medium)
                            .foregroundColor(.primary)
                    }
                    
                    // æŸ±ç‹€åœ– (Bar Chart)
                    GeometryReader { geometry in
                        ZStack(alignment: .leading) {
                            RoundedRectangle(cornerRadius: 3)
                                .fill(Color.gray.opacity(0.15))
                                .frame(height: 8)
                            
                            RoundedRectangle(cornerRadius: 3)
                                .fill(color)
                                .frame(width: geometry.size.width * percentage, height: 8)
                        }
                    }
                    .frame(height: 8)
                }
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: Color.black.opacity(0.05), radius: 5, x: 0, y: 2)
    }
}


// MARK: - 1. é ç´„åˆ—è¡¨è¦–åœ– (Appointment List View - Tab 1) Helper

/// é ç´„åˆ—è¡¨çš„å–®å…ƒæ ¼è¦–åœ–
struct AppointmentRow: View {
    let appointment: Appointment
    let members: [Member]
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                // å„ªåŒ–ï¼šä½¿ç”¨ guard let ç°¡åŒ–æŸ¥æ‰¾æˆå“¡é¡è‰²çš„é‚è¼¯
                let memberColor = members.first(where: { $0.name == appointment.name })?.colorHex ?? "#000000"
                Circle()
                    .fill(Color(hex: memberColor))
                    .frame(width: 10, height: 10)
                    .padding(.trailing, 4)

                Text(appointment.name)
                    .font(.title3)
                    .fontWeight(.bold)
                    .foregroundColor(.primary)
                
                Spacer()
                
                Text(appointment.service)
                    .font(.caption)
                    .fontWeight(.medium)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(Color.indigo.opacity(0.15))
                    .foregroundColor(.indigo)
                    .cornerRadius(8)
            }
            
            // é¡¯ç¤ºé¡å¤–æœå‹™æè¿°
            if let detail = appointment.extraServiceDetail, !detail.isEmpty {
                Text("é™„è¨»: \(detail)")
                    .font(.caption2)
                    .foregroundColor(.secondary)
            }
            
            // æ—¥æœŸèˆ‡æ™‚é–“
            HStack(spacing: 4) {
                Image(systemName: "clock")
                Text(appointment.date, style: .date)
                Text("@")
                Text(appointment.date, style: .time)
            }
            .font(.footnote)
            .foregroundColor(.secondary)
        
            // æ¶ˆè²»é‡‘é¡
            if let amount = appointment.amount {
                Text("é‡‘é¡: $\(amount, specifier: "%.0f") (é ç´„æ”¯å‡º)")
                    .font(.subheadline)
                    .fontWeight(.bold)
                    .foregroundColor(.red)
            }
          
            // ç…§ç‰‡å‚™è¨»æç¤º
            if let desc = appointment.photoDescription, !desc.isEmpty || appointment.isPhotoAttached {
                HStack(spacing: 4) {
                    Image(systemName: appointment.isPhotoAttached ? "photo.fill" : "camera.fill").foregroundColor(.orange)
                    Text(appointment.isPhotoAttached ? "å·²é™„åŠ ç…§ç‰‡" : "å·²è¨˜éŒ„æ–‡å­—å‚™è¨»")
                }
                .font(.caption)
            }
        }
        .padding(.vertical, 4)
    }
}


/// é ç´„åˆ—è¡¨è¦–åœ– (Tab 1)
struct AppointmentListView: View {
    @Binding var appointments: [Appointment]
    let members: [Member]
    var saveAction: () -> Void
    var deleteAction: (IndexSet) -> Void
    
    @State private var isShowingAddAppointment = false
    
    // ä¿®æ­£ Type-Check éŒ¯èª¤ï¼šå°‡è¤‡é›œçš„ Binding é‚è¼¯æå–åˆ°ç¨ç«‹å‡½å¼ä¸­
    private func binding(for appointment: Appointment) -> Binding<Appointment>? {
        guard let index = appointments.firstIndex(where: { $0.id == appointment.id }) else {
            return nil
        }
        return Binding(
            get: { self.appointments[index] },
            set: { self.appointments[index] = $0 }
        )
    }
    
    var body: some View {
        NavigationView {
            VStack {
                if appointments.isEmpty {
                    Spacer()
                    ContentUnavailableView {
                        Label("ç›®å‰æ²’æœ‰é ç´„", systemImage: "calendar.badge.plus")
                    } description: {
                        Text("é»æ“Šå³ä¸Šè§’çš„ã€Œ+ã€æ–°å¢ä¸€å€‹é ç´„ã€‚")
                    }
                    Spacer()
                } else {
                    List {
                        // ä¾æ“šæ—¥æœŸæ’åºé ç´„
                        ForEach(appointments.sorted(by: { $0.date < $1.date })) { appointment in
                            // é»æ“Šå¾Œé€²å…¥ç·¨è¼¯é é¢
                            if let appointmentBinding = binding(for: appointment) {
                                NavigationLink(destination: EditAppointmentView(
                                    // ä½¿ç”¨æå–å¾Œçš„ç°¡åŒ– Binding
                                    appointment: appointmentBinding,
                                    saveAction: saveAction
                                )) {
                                    AppointmentRow(appointment: appointment, members: members)
                                }
                            }
                        }
                        .onDelete(perform: deleteAction)
                    }
                    .listStyle(.insetGrouped)
                }
            }
            // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (VStack)
            .navigationTitle("é ç´„åˆ—è¡¨")
            .toolbar {
                ToolbarItem(placement: .topBarLeading) {
                    if !appointments.isEmpty {
                        EditButton()
                    }
                }
                ToolbarItem(placement: .topBarTrailing) {
                    Button {
                        isShowingAddAppointment = true
                    } label: {
                        Label("æ–°å¢é ç´„", systemImage: "plus.circle.fill")
                    }
                }
            }
            .sheet(isPresented: $isShowingAddAppointment) {
                AddAppointmentView(appointments: $appointments, members: members, saveAction: saveAction)
            }
        }
    }
}


// MARK: - 2. é ç´„æ­·å²è¨˜éŒ„è¦–åœ– (History View - Tab 2)

/// é ç´„æ­·å²è¨˜éŒ„è¦–åœ– (Tab 2)
struct HistoryView: View {
    let appointments: [Appointment]

    var groupedAppointments: [String: [Appointment]] {
        Dictionary(grouping: appointments.sorted(by: { $0.date > $1.date })) { appointment in
            let formatter = DateFormatter()
            formatter.dateFormat = "yyyyå¹´ MMæœˆ"
            return formatter.string(from: appointment.date)
        }
    }
    
    var sortedKeys: [String] {
        groupedAppointments.keys.sorted(by: >)
    }

    var body: some View {
        NavigationView {
            List {
                if appointments.isEmpty {
                    ContentUnavailableView {
                        Label("ç„¡æ­·å²è¨˜éŒ„", systemImage: "clock.badge.xmark")
                    } description: {
                        Text("æ–°å¢é ç´„å¾Œï¼Œè¨˜éŒ„å°‡åœ¨æ­¤è™•æŒ‰æœˆä»½åˆ†é¡é¡¯ç¤ºã€‚")
                    }
                } else {
                    ForEach(sortedKeys, id: \.self) { month in
                        Section(header: Text(month).font(.headline).foregroundColor(.indigo)) {
                            ForEach(groupedAppointments[month]!) { appointment in
                                VStack(alignment: .leading, spacing: 5) {
                                    HStack {
                                        Text(appointment.name)
                                            .fontWeight(.semibold)
                                        Spacer()
                                        Text(appointment.service)
                                            .font(.caption)
                                            .fontWeight(.medium)
                                            .padding(.horizontal, 8)
                                            .background(Color.indigo.opacity(0.1))
                                            .cornerRadius(5)
                                    }
              
                                    if let detail = appointment.extraServiceDetail, !detail.isEmpty {
                                        Text("é™„è¨»: \(detail)")
                                            .font(.caption2)
                                            .foregroundColor(.secondary)
                                    }
                       
                                    HStack {
                                        Text(appointment.date, style: .time)
                                            .font(.subheadline)
                                
                                        if let amount = appointment.amount {
                                            Text("|")
                                                .foregroundColor(.secondary)
                                            Text("é ç´„æ”¯å‡º: $\(amount, specifier: "%.0f")")
                                                .foregroundColor(.red)
                                                .fontWeight(.medium)
                                        }
        
                                        if appointment.isPhotoAttached {
                                            Text("|")
                                                .foregroundColor(.secondary)
                                            Image(systemName: "photo.fill")
                                                .foregroundColor(.orange)
                                        }
                                    }
                                    .font(.subheadline)
                                    .foregroundColor(.secondary)
                            }
                        }
                    }
                }
            }
            // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (List)
            .navigationTitle("é ç´„æ­·å²è¨˜éŒ„")
        }
    }
}

// MARK: - 3. æ”¶å…¥/æ”¯å‡ºè¦–åœ– (Income Expense View - Tab 3)

/// æ”¶å…¥/æ”¯å‡ºè¦–åœ– (Tab 3)
struct IncomeExpenseView: View {
    let appointments: [Appointment]
    @Binding var generalTransactions: [GeneralTransaction]
    let members: [Member]
    var saveAction: () -> Void
    
    @State private var currentDate = Date()
    @State private var isAddingTransaction = false
    @State private var selectedDate: Date?
    // è¨ˆç®—ç•¶å‰é¡¯ç¤ºæœˆä»½çš„é–‹å§‹å’ŒçµæŸæ—¥æœŸ
    var monthStart: Date {
        Calendar.current.date(from: Calendar.current.dateComponents([.year, .month], from: currentDate))!
    }
    var monthEnd: Date {
        Calendar.current.date(byAdding: DateComponents(month: 1, day: -1), to: monthStart)!
    }
    
    // è¨ˆç®—æ—¥æ›†ç¶²æ ¼æ‰€éœ€çš„æ—¥æœŸ
    var daysInMonth: [Date] {
        var dates: [Date] = []
        let range = Calendar.current.range(of: .day, in: .month, for: monthStart)!
        for i in range {
            if let date = Calendar.current.date(byAdding: .day, value: i - 1, to: monthStart) {
                dates.append(date)
            }
        }
        return dates
    }
    
    // å–å¾—æŒ‡å®šæ—¥æœŸæ‰€æœ‰äº¤æ˜“ (é ç´„ + ä¸€èˆ¬)
    func getDailyTransactions(for date: Date) -> (totalExpense: Double, totalIncome: Double, expenseMembers: [String: Double]) {
        let dayStart = Calendar.current.startOfDay(for: date)
        let dayEnd = Calendar.current.date(byAdding: .day, value: 1, to: dayStart)!
        var totalExpense = 0.0
        var totalIncome = 0.0
        var expenseMembers: [String: Double] = [:]
        
        // 1. é ç´„æ”¯å‡º
        let dailyAppointments = appointments.filter { $0.date >= dayStart && $0.date < dayEnd && $0.amount != nil }
        for appt in dailyAppointments {
            totalExpense += appt.amount!
            expenseMembers[appt.name, default: 0] += appt.amount!
        }
        
        // 2. ä¸€èˆ¬äº¤æ˜“
        let dailyTransactions = generalTransactions.filter { $0.date >= dayStart && $0.date < dayEnd }
        for transaction in dailyTransactions {
            if transaction.type == .expense {
                totalExpense += transaction.amount
                expenseMembers[transaction.memberName, default: 0] += transaction.amount
            } else {
                totalIncome += transaction.amount
            }
        }
        
        return (totalExpense, totalIncome, expenseMembers)
    }

    // æœˆä»½å°èˆª
    func changeMonth(by value: Int) {
        if let newDate = Calendar.current.date(byAdding: .month, value: value, to: currentDate) {
            currentDate = newDate
        }
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // æœˆä»½å°èˆª
                HStack {
                    Button { changeMonth(by: -1) } label: { Image(systemName: "chevron.left") }
                    Spacer()
                    Text(monthStart, format: .dateTime.year().month())
                        .font(.title2).fontWeight(.bold)
                    Spacer()
                    Button { changeMonth(by: 1) } label: { Image(systemName: "chevron.right") }
                }
                .padding()
                .background(Color(.systemBackground))

                // æ—¥æ›†ç¶²æ ¼
                CalendarGridView(daysInMonth: daysInMonth, members: members, getDailyTransactions: getDailyTransactions) { date in
                    selectedDate = date
                    isAddingTransaction = true
                }
                .padding(.horizontal)
                
                // æ”¯å‡ºç¸½çµåœ–ä¾‹
                ScrollView(.horizontal, showsIndicators: false) {
                    HStack {
                        ForEach(members.sorted { $0.name < $1.name }) { member in
                            HStack {
                                Circle()
                                    .fill(Color(hex: member.colorHex))
                                    .frame(width: 10, height: 10)
                                Text(member.name)
                                    .font(.caption)
                            }
                            .padding(.horizontal, 8)
                            .padding(.vertical, 4)
                            .background(Color.gray.opacity(0.1))
                            .cornerRadius(8)
                        }
                    }
                    .padding()
                }
            }
            // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (VStack)
            .navigationTitle("æ”¶æ”¯æœˆæ›†")
            .sheet(isPresented: $isAddingTransaction) {
                AddGeneralTransactionView(
                    generalTransactions: $generalTransactions,
                    members: members,
                    saveAction: saveAction,
                    initialDate: selectedDate ?? Date()
                )
            }
        }
    }
}


// MARK: - 4. æ”¯å‡ºå ±å‘Šè¦–åœ– (Report View - Tab 4)

/// æ”¯å‡ºå ±å‘Šè¦–åœ– (Tab 4)
struct ReportView: View {
    let appointments: [Appointment]
    let generalTransactions: [GeneralTransaction]
    let members: [Member]
    
    enum ReportCategory: String, CaseIterable, Identifiable {
        case service = "é ç´„æœå‹™ç¸½è¨ˆ"
        case member = "æˆå“¡æ”¯å‡ºç¸½çµ"
        case month = "æœˆä»½æ”¯å‡ºç¸½è¨ˆ"
        var id: String { self.rawValue }
    }
    
    @State private var selectedCategory: ReportCategory = .service
    
    // ç¸½æ”¯å‡º (é ç´„æ”¯å‡º + ä¸€èˆ¬æ”¯å‡º)
    var overallTotalExpense: Double {
        let apptExpense = appointments.reduce(0) { $0 + ($1.amount ?? 0) }
        let generalExpense = generalTransactions
            .filter { $0.type == .expense }
            .reduce(0) { $0 + $1.amount }
        return apptExpense + generalExpense
    }
    
    var overallTotalIncome: Double {
        generalTransactions
            .filter { $0.type == .income }
            .reduce(0) { $0 + $1.amount }
    }
    
    // ä¾æœå‹™åˆ†é¡çš„ç¸½è¨ˆ (Service Totals - åƒ…é ç´„)
    var serviceTotals: [(service: String, total: Double)] {
        let grouped = Dictionary(grouping: appointments.compactMap { $0.amount != nil ? ($0.service, $0.amount!) : nil }) { $0.0 }
        return grouped.map { (service, items) in
            let total = items.reduce(0) { $0 + $1.1 }
            return (service, total)
        }.sorted { $0.total > $1.total }
    }
    
    // ä¾æˆå“¡åˆ†é¡çš„ç¸½è¨ˆ (Member Totals - é ç´„ + ä¸€èˆ¬æ”¯å‡º)
    var memberTotals: [(member: String, total: Double, colorHex: String)] {
        var totals: [String: Double] = [:]
        
        // 1. é ç´„æ”¯å‡º
        for appt in appointments where appt.amount != nil {
            totals[appt.name, default: 0] += appt.amount!
        }
        
        // 2. ä¸€èˆ¬æ”¯å‡º
        for transaction in generalTransactions where transaction.type == .expense {
            totals[transaction.memberName, default: 0] += transaction.amount
        }
        
        return totals.map { (name, total) in
            let color = members.first(where: { $0.name == name })?.colorHex ?? "#000000"
            return (name, total, color)
        }.sorted { $0.total > $1.total }
    }
    
    // ä¾æœˆä»½åˆ†é¡çš„ç¸½è¨ˆ (Month Totals - é ç´„ + ä¸€èˆ¬æ”¯å‡º)
    var monthTotals: [(month: String, total: Double)] {
        var monthlyTotals: [String: Double] = [:]
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyyå¹´ MMæœˆ"
       
        // 1. é ç´„æ”¯å‡º
        for appt in appointments where appt.amount != nil {
            let month = formatter.string(from: appt.date)
            monthlyTotals[month, default: 0] += appt.amount!
        }
        
        // 2. ä¸€èˆ¬æ”¯å‡º
        for transaction in generalTransactions where transaction.type == .expense {
            let month = formatter.string(from: transaction.date)
            monthlyTotals[month, default: 0] += transaction.amount
        }
        
        return monthlyTotals.map { (month, total) in
            return (month, total)
        }.sorted { $0.month > $1.month }
    }
    
    var body: some View {
        NavigationView {
            VStack {
                if overallTotalExpense == 0 && overallTotalIncome == 0 {
                    ContentUnavailableView {
                        Label("ç„¡ç‡Ÿæ”¶æˆ–æ”¯å‡ºè³‡æ–™", systemImage: "chart.bar.xaxis.ascending")
                    } description: {
                        Text("è«‹æ–°å¢é ç´„ä¸¦å¡«å¯«é‡‘é¡ï¼Œæˆ–åœ¨ã€Œæ”¶å…¥/æ”¯å‡ºã€é é¢è¨˜éŒ„æ—¥å¸¸æ”¶æ”¯ã€‚")
                    }
                } else {
                    List {
                        // ç¸½è¦½
                        Section("å®¶åº­æ”¶æ”¯ç¸½è¦½ (Total Overview)") {
                            HStack {
                                Text("ç´¯ç©ç¸½æ”¯å‡º")
                                Spacer()
                                Text("$\(overallTotalExpense, specifier: "%.0f")")
                                    .font(.title2)
                                    .fontWeight(.bold)
                                    .foregroundColor(.red)
                            }
                            HStack {
                                Text("ç´¯ç©ç¸½æ”¶å…¥")
                                Spacer()
                                Text("$\(overallTotalIncome, specifier: "%.0f")")
                                    .font(.title2)
                                    .fontWeight(.bold)
                                    .foregroundColor(.green)
                            }
                        }
                        
                        // MARK: - æ¯”ä¾‹åˆ†æåœ–è¡¨
                        if overallTotalExpense > 0 {
                            Section("æ”¯å‡ºæ¯”ä¾‹åˆ†æ (Proportion Analysis)") {
                                // ä½¿ç”¨ä¸€å€‹ç«‹å³åŸ·è¡Œé–‰åŒ…ä¾†è¨ˆç®— chartData çš„å€¼
                                let chartData = { () -> [(label: String, value: Double)] in
                                    switch selectedCategory {
                                    case .service:
                                        return serviceTotals.map { ($0.service, Double($0.total)) }
                                    case .member:
                                        return memberTotals.map { ($0.member, Double($0.total)) }
                                    case .month:
                                        // ä¿®æ­£ï¼šç•¶é¸æ“‡æœˆä»½å ±å‘Šæ™‚ï¼Œæ‡‰ä½¿ç”¨ monthTotals
                                        return monthTotals.map { ($0.month, Double($0.total)) }
                                    }
                                }() // æ‹¬è™Ÿè¡¨ç¤ºç«‹å³åŸ·è¡Œé€™å€‹é–‰åŒ…
                     
                                ProportionChart(
                                    data: chartData,
                                    total: overallTotalExpense
                                )
                                .listRowInsets(EdgeInsets(top: 15, leading: 0, bottom: 15, trailing: 0))
                            }
                            
                            // åˆ†é¡åˆ‡æ›é¸æ“‡å™¨
                            Picker("åˆ†é¡æ–¹å¼", selection: $selectedCategory) {
                                ForEach(ReportCategory.allCases) { category in
                                    Text(category.rawValue).tag(category)
                                }
                            }
                            .pickerStyle(.segmented)
                            .listRowInsets(EdgeInsets())
                            .padding([.horizontal, .top], 10)
                            
                            // å ±å‘Šè©³ç´°åˆ—è¡¨
                            switch selectedCategory {
                            case .service:
                                Section(ReportCategory.service.rawValue) {
                                    ForEach(serviceTotals, id: \.service) { item in
                                        HStack {
                                            Image(systemName: "tag.fill").foregroundColor(.indigo)
                                            Text(item.service)
                                            Spacer()
                                            Text("$\(item.total, specifier: "%.0f")")
                                                .fontWeight(.medium)
                                        }
                                    }
                                }
                            case .member:
                                Section(ReportCategory.member.rawValue) {
                                    ForEach(memberTotals, id: \.member) { item in
                                        HStack {
                                            Circle()
                                                .fill(Color(hex: item.colorHex))
                                                .frame(width: 10, height: 10)
                                            Text(item.member)
                                            Spacer()
                                            Text("$\(item.total, specifier: "%.0f")")
                                                .fontWeight(.medium)
                                                .foregroundColor(.red)
                                        }
                                    }
                                }
                            case .month:
                                Section(ReportCategory.month.rawValue) {
                                    ForEach(monthTotals, id: \.month) { item in
                                        HStack {
                                            Image(systemName: "calendar").foregroundColor(.green)
                                            Text(item.month)
                                            Spacer()
                                            Text("$\(item.total, specifier: "%.0f")")
                                                .fontWeight(.medium)
                                                .foregroundColor(.red)
                                        }
                                    }
                                }
                            }
                        }
                    }
                    .listStyle(.insetGrouped)
                }
                // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (VStack)
                .navigationTitle("æ”¯å‡ºå ±å‘Š")
            }
        }
    }
}


// MARK: - 5. æˆå“¡ç®¡ç†è¦–åœ– (Member Management View - Tab 5)

/// æˆå“¡ç®¡ç†è¦–åœ– (Tab 5)
struct MemberManagementView: View {
    @Binding var members: [Member]
    var saveAction: () -> Void
    
    @State private var newMemberName: String = ""
    @State private var selectedColorHex: String = Color.memberHexes.first!
    // é è¨­ç¬¬ä¸€å€‹é¡è‰²
    
    var body: some View {
        NavigationView {
            VStack {
                Form {
                    Section("æ–°å¢å®¶åº­æˆå“¡") {
                        HStack {
                            TextField("è¼¸å…¥æˆå“¡å§“å", text: $newMemberName)
                                .textInputAutocapitalization(.words)
    
                            Button {
                                addMember()
                            } label: {
                                Image(systemName: "plus.circle.fill")
                                    .foregroundColor(.indigo)
                            }
                            .disabled(newMemberName.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty)
                        }
                    }
                    
                    Section("é¸æ“‡æˆå“¡ä»£è¡¨è‰²") {
                        ScrollView(.horizontal, showsIndicators: false) {
                            HStack {
                                ForEach(Color.memberHexes, id: \.self) { hex in
                                    Circle()
                                        .fill(Color(hex: hex))
                                        .frame(width: 30, height: 30)
                                        .overlay(
                                            hex == selectedColorHex ?
                                            Circle().stroke(Color.primary, lineWidth: 2) : nil
                                        )
                                        .onTapGesture {
                                            selectedColorHex = hex
                                        }
                                }
                            }
                        }
                    }
                    
                    Section("ç¾æœ‰å®¶åº­æˆå“¡åˆ—è¡¨") {
                        if members.isEmpty {
                            Text("ç›®å‰æ²’æœ‰æˆå“¡ã€‚")
                                .foregroundColor(.secondary)
                        } else {
                            List {
                                ForEach(members) { member in
                                    HStack {
                                        Circle()
                                            .fill(Color(hex: member.colorHex))
                                            .frame(width: 15, height: 15)
                                        Text(member.name)
                                        Spacer()
                                    }
                                }
                                .onDelete(perform: deleteMembers)
                            }
                        }
                    }
                }
            }
            // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (VStack)
            .navigationTitle("æˆå“¡ç®¡ç†")
            .toolbar {
                ToolbarItem(placement: .topBarLeading) {
                    if !members.isEmpty {
                        EditButton()
                    }
                }
            }
        }
    }
    
    func addMember() {
        let trimmedName = newMemberName.trimmingCharacters(in: .whitespacesAndNewlines)
        guard !trimmedName.isEmpty else { return }
        
        let newMember = Member(name: trimmedName, colorHex: selectedColorHex)
        members.append(newMember)
        members.sort { $0.name < $1.name }
        saveAction()
        
        newMemberName = ""
        
        let generator = UIImpactFeedbackGenerator(style: .light)
        generator.impactOccurred()
    }
    
    func deleteMembers(at offsets: IndexSet) {
        members.remove(atOffsets: offsets)
        saveAction()
    }
}

// MARK: - 6. æ–°å¢æ—¥å¸¸äº¤æ˜“è¦–åœ– (Add General Transaction View)

/// æ–°å¢æ—¥å¸¸äº¤æ˜“è¦–åœ–
struct AddGeneralTransactionView: View {
    @Binding var generalTransactions: [GeneralTransaction]
    let members: [Member]
    var saveAction: () -> Void
    let initialDate: Date
    
    @Environment(\.dismiss) var dismiss
 
    @State private var amountInput: String = ""
    @State private var transactionDate: Date
    @State private var selectedMember: Member?
    @State private var description: String = ""
    @State private var transactionType: GeneralTransaction.TransactionType = .expense
    
    init(generalTransactions: Binding<[GeneralTransaction]>, members: [Member], saveAction: @escaping () -> Void, initialDate: Date) {
        self._generalTransactions = generalTransactions
        self.members = members
        self.saveAction = saveAction
        self.initialDate = initialDate
        self._transactionDate = State(initialValue: initialDate)
        
        // é è¨­é¸æ“‡ç¬¬ä¸€å€‹æˆå“¡
        if let firstMember = members.first {
            self._selectedMember = State(initialValue: firstMember)
        } else {
            self._selectedMember = State(initialValue: nil)
        }
    }
    
    var isSaveButtonDisabled: Bool {
        amountInput.isEmpty || selectedMember == nil
    }
    
    var body: some View {
        NavigationView {
            Form {
                Picker("é¡å‹", selection: $transactionType) {
                    Text("æ”¯å‡º (Expense)").tag(GeneralTransaction.TransactionType.expense)
                    Text("æ”¶å…¥ (Income)").tag(GeneralTransaction.TransactionType.income)
                }
                .pickerStyle(.segmented)
                
                Section("åŸºæœ¬è³‡è¨Š") {
                    DatePicker("æ—¥æœŸèˆ‡æ™‚é–“", selection: $transactionDate, displayedComponents: [.date, .hourAndMinute])
                        .datePickerStyle(.compact)
                    
                    if !members.isEmpty {
                        Picker("æ­¸å±¬æˆå“¡", selection: $selectedMember) {
                            ForEach(members, id: \.self) { member in
                                HStack {
                                    Circle()
                                        .fill(Color(hex: member.colorHex))
                                        .frame(width: 10, height: 10)
                                    Text(member.name)
                                }
                                .tag(Optional(member))
                            }
                        }
                    } else {
                        Text("âš ï¸ è«‹å…ˆåœ¨ã€Œæˆå“¡ç®¡ç†ã€é é¢æ–°å¢å®¶åº­æˆå“¡")
                            .foregroundColor(.orange)
                    }
                    
                    HStack {
                        Text(transactionType == .expense ? "æ”¯å‡ºé‡‘é¡" : "æ”¶å…¥é‡‘é¡")
                        Spacer()
                        TextField("é‡‘é¡", text: $amountInput)
                            .keyboardType(.decimalPad)
                            .multilineTextAlignment(.trailing)
                            .foregroundColor(transactionType == .expense ? .red : .green)
                    }
                }
                
                Section("èªªæ˜/å‚™è¨» (é¸å¡«)") {
                    TextEditor(text: $description)
                        .frame(height: 80)
                }
                
                Button("å„²å­˜äº¤æ˜“è¨˜éŒ„") {
                    saveTransaction()
                }
                .disabled(isSaveButtonDisabled)
                .frame(maxWidth: .infinity)
                .buttonStyle(.borderedProminent)
            }
            // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (Form)
            .navigationTitle(transactionType == .expense ? "æ–°å¢æ—¥å¸¸æ”¯å‡º" : "æ–°å¢æ—¥å¸¸æ”¶å…¥")
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("å–æ¶ˆ") { dismiss() }
                }
            }
        }
    }
    
    func saveTransaction() {
        guard let member = selectedMember,
              let parsedAmount = Double(amountInput.trimmingCharacters(in: .whitespacesAndNewlines))
        else { return }
        
        let trimmedDesc = description.trimmingCharacters(in: .whitespacesAndNewlines)
        
        let newTransaction = GeneralTransaction(
            date: transactionDate,
            memberName: member.name,
            amount: parsedAmount,
            description: trimmedDesc.isEmpty ? (transactionType == .expense ? "ä¸€èˆ¬æ”¯å‡º" : "ä¸€èˆ¬æ”¶å…¥") : trimmedDesc,
            type: transactionType
        )
        
        generalTransactions.append(newTransaction)
        saveAction()
        dismiss()
    }
}


// MARK: - 7. ç·¨è¼¯é ç´„è¦–åœ– (Edit Appointment View)

/// ç·¨è¼¯é ç´„è¦–åœ–
struct EditAppointmentView: View {
    @Binding var appointment: Appointment
    var saveAction: () -> Void
    @Environment(\.dismiss) var dismiss
    
    @State private var amountInput: String
    @State private var photoDescription: String
    @State private var isPhotoAttached: Bool
    @State private var extraServiceDetail: String
    
    init(appointment: Binding<Appointment>, saveAction: @escaping () -> Void) {
        self._appointment = appointment
        self.saveAction = saveAction
        
        _amountInput = State(initialValue: appointment.wrappedValue.amount.map { String(format: "%.0f", $0) } ?? "")
        _photoDescription = State(initialValue: appointment.wrappedValue.photoDescription ?? "")
        self._isPhotoAttached = State(initialValue: appointment.wrappedValue.isPhotoAttached)
        _extraServiceDetail = State(initialValue: appointment.wrappedValue.extraServiceDetail ?? "")
    }
    
    var body: some View {
        Form {
            // MARK: é ç´„æ‘˜è¦ (ä¸å¯ä¿®æ”¹æ¬„ä½)
            Section("é ç´„è€…èˆ‡æœå‹™è³‡è¨Š") {
                HStack {
                    Image(systemName: "person.circle.fill").foregroundColor(.indigo)
                    Text("å®¢æˆ¶/æˆå“¡: \(appointment.name)")
                }
                HStack {
                    Image(systemName: "tag.square.fill").foregroundColor(.indigo)
                    Text("æœå‹™: \(appointment.service)")
                }
                HStack {
                    Image(systemName: "calendar.badge.clock.fill").foregroundColor(.indigo)
                    Text("æ™‚é–“: \(appointment.date, style: .date) \(appointment.date, style: .time)")
                }
            
                // é¡å¤–æœå‹™å…§å®¹ç·¨è¼¯
                if appointment.service.contains("å…¶ä»–") || !(appointment.extraServiceDetail ?? "").isEmpty {
                    VStack(alignment: .leading) {
                        Text("é¡å¤–æœå‹™å…§å®¹")
                            .font(.caption)
                            .foregroundColor(.secondary)
                        TextField("è«‹æè¿°é¡å¤–æœå‹™å…§å®¹", text: $extraServiceDetail, axis: .vertical)
                            .lineLimit(2...5)
                    }
                }
            }
            
            // MARK: æ¶ˆè²»é‡‘é¡ä¿®æ”¹
            Section("ä¿®æ”¹æ¶ˆè²»é‡‘é¡") {
                HStack {
                    Text("$")
                        .foregroundColor(.secondary)
                    TextField("é‡‘é¡", text: $amountInput)
                        .keyboardType(.decimalPad)
                        .multilineTextAlignment(.trailing)
                }
            }
         
            // MARK: ç…§ç‰‡è¨˜éŒ„èˆ‡ç®¡ç†
            Section("ç…§ç‰‡è¨˜éŒ„èˆ‡ç®¡ç†") {
                VStack(alignment: .leading, spacing: 10) {
                    if isPhotoAttached {
                        VStack(alignment: .center, spacing: 10) {
                            Text("âš ï¸ åœ–ç‰‡åŠŸèƒ½æ¨¡æ“¬ (Canvas é™åˆ¶)")
                                .font(.caption).foregroundColor(.red)
                         
                            Image(systemName: "photo.on.rectangle.fill")
                                .resizable()
                                .scaledToFit()
                                .frame(height: 100)
                                .foregroundColor(.gray.opacity(0.7))
                                .background(Color.gray.opacity(0.1))
                                .cornerRadius(10)
                                .padding(.vertical, 5)
                            
                            Button("ç§»é™¤é™„åŠ ç…§ç‰‡") {
                                isPhotoAttached = false
                            }
                            .foregroundColor(.red)
                        }
                        .frame(maxWidth: .infinity)
                        
                    } else {
                        Button {
                            isPhotoAttached = true
                        } label: {
                            HStack {
                                Image(systemName: "camera.on.rectangle.fill")
                                Text("æ‹ç…§è¨˜éŒ„ (æ¨¡æ“¬)")
                            }
                        }
                        
                        Button {
                            isPhotoAttached = true
                        } label: {
                            HStack {
                                Image(systemName: "photo.stack.fill")
                                Text("å¾ç›¸ç°¿é¸æ“‡æª”æ¡ˆ (æ¨¡æ“¬)")
                            }
                        }
                    }
                }
                
                // å‚™è¨»æ–‡æœ¬å€åŸŸ
                TextEditor(text: $photoDescription)
                    .frame(height: 100)
                    .overlay(
                        Text(photoDescription.isEmpty ? "æ–°å¢ç…§ç‰‡ç›¸é—œæ–‡å­—æè¿°æˆ–å‚™è¨»..." : "")
                            .foregroundColor(.secondary)
                            .allowsHitTesting(false)
                            .padding(.top, 8)
                            .padding(.leading, 5),
                        alignment: .topLeading
                    )
            }
            
            // å„²å­˜æŒ‰éˆ•
            Button("å„²å­˜ä¿®æ”¹ä¸¦æ›´æ–°è¨˜éŒ„") {
                saveChanges()
            }
            .frame(maxWidth: .infinity)
            .buttonStyle(.borderedProminent)
            .padding(.top)
        }
        // ä¿®æ­£ï¼šå› ç‚º EditAppointmentView ä½œç‚º NavigationLink çš„ç›®çš„åœ°ï¼Œ
        // navigationTitle å¿…é ˆæ‡‰ç”¨åˆ°æœ€å¤–å±¤çš„ View (Form)
        .navigationTitle("ç·¨è¼¯æ­·å²è¨˜éŒ„")
        .navigationBarTitleDisplayMode(.inline)
    }
    
    func saveChanges() {
        let trimmedAmount = amountInput.trimmingCharacters(in: .whitespacesAndNewlines)
        let parsedAmount = Double(trimmedAmount)
        
        appointment.amount = parsedAmount
        
        let trimmedPhotoDesc = photoDescription.trimmingCharacters(in: .whitespacesAndNewlines)
        appointment.photoDescription = trimmedPhotoDesc.isEmpty ? nil : trimmedPhotoDesc
        
        let trimmedExtraDetail = extraServiceDetail.trimmingCharacters(in: .whitespacesAndNewlines)
        appointment.extraServiceDetail = trimmedExtraDetail.isEmpty ? nil : trimmedExtraDetail
        
        appointment.isPhotoAttached = isPhotoAttached
        
        saveAction()
        dismiss()
    }
}


// MARK: - 8. æ–°å¢é ç´„è¦–åœ– (Add Appointment View)

/// æ–°å¢é ç´„è¦–åœ–
struct AddAppointmentView: View {
    @Binding var appointments: [Appointment]
    let members: [Member]
    var saveAction: () -> Void
    
    @Environment(\.dismiss) var dismiss
    
    let eventStore = EKEventStore()
    
    // æœå‹™é …ç›®æ–°å¢ Emoji/åœ–æ¨™
    private let availableServices = [
        "ğŸ’‡ å‰ªé«® (Haircut)",
        "ğŸ’† æŒ‰æ‘© (Massage)",
        "ğŸ’¬ è«®è©¢ (Consultation)",
        "ğŸ’… ç¾ç”² (Manicure)",
        "â“ å…¶ä»– (Other)"
    ]
    
    // é ç´„è€…åç¨±é¸é …ï¼ŒåŒ…å«å®¶åº­æˆå“¡å’Œä¸€å€‹ã€Œæ‰‹å‹•è¼¸å…¥ã€é¸é …
    enum NameSource: String, CaseIterable, Identifiable {
        case member = "å®¶åº­æˆå“¡"
        case manual = "æ–°å¢éæˆå“¡å§“å"
        var id: String { self.rawValue }
    }
    
    @State private var calendarStatusMessage: String?
    @State private var isShowingStatusAlert = false
    
    // é ç´„è€…è³‡è¨Š
    @State private var nameSource: NameSource = .manual
    @State private var name: String = ""
    @State private var selectedMember: Member?
    @State private var service: String = "ğŸ’‡ å‰ªé«® (Haircut)"
    @State private var date: Date = Calendar.current.date(byAdding: .hour, value: 1, to: Date()) ?? Date()
    @State private var email: String = ""
    @State private var phone: String = ""
    @State private var amountInput: String = ""
    @State private var photoDescription: String = ""
    @State private var extraServiceDetail: String = ""
    
    var finalName: String {
        if nameSource == .manual {
            return name
        } else {
            return selectedMember?.name ?? (members.first?.name ?? "")
        }
    }
    
    var body: some View {
        NavigationView {
            Form {
                // MARK: é ç´„è€…è³‡è¨Š (æ–°å¢æˆå“¡é¸æ“‡é‚è¼¯)
                Section("é ç´„è€…/å®¶åº­æˆå“¡ (å¿…å¡«)") {
                    Picker("é ç´„è€…ä¾†æº", selection: $nameSource) {
                        Text("æ–°å¢éæˆå“¡å§“å").tag(NameSource.manual)
                        
                        if !members.isEmpty {
                            Text("é¸æ“‡å®¶åº­æˆå“¡").tag(NameSource.member)
                        }
                    }
                    .pickerStyle(.segmented)
                    
                    if nameSource == .manual {
                        TextField("é ç´„è€…å§“å", text: $name)
                            .textInputAutocapitalization(.words)
                    } else if nameSource == .member && !members.isEmpty {
                        Picker("é¸æ“‡æˆå“¡", selection: $selectedMember) {
                            ForEach(members, id: \.self) { member in
                                HStack {
                                    Circle()
                                        .fill(Color(hex: member.colorHex))
                                        .frame(width: 10, height: 10)
                                    Text(member.name)
                                }
                                .tag(Optional(member))
                            }
                        }
                        .onAppear {
                            if selectedMember == nil, let first = members.first {
                                selectedMember = first
                            }
                        }
                    } else if nameSource == .member && members.isEmpty {
                        Text("âš ï¸ è«‹å…ˆåœ¨ã€Œæˆå“¡ç®¡ç†ã€é é¢æ–°å¢å®¶åº­æˆå“¡")
                            .foregroundColor(.orange)
                            .onAppear {
                                nameSource = .manual // å¼·åˆ¶åˆ‡æ›å›æ‰‹å‹•è¼¸å…¥
                            }
                    }
                }
                
                // MARK: é ç´„æœå‹™è³‡è¨Š
                Section("é ç´„æœå‹™è³‡è¨Š") {
                    Picker("æœå‹™é …ç›®", selection: $service) {
                        ForEach(availableServices, id: \.self) { serviceOption in
                            Text(serviceOption)
                        }
                    }
                   
                    // æ ¹æ“šæœå‹™é …ç›®é¡¯ç¤ºé¡å¤–è¼¸å…¥æ¬„ä½
                    if service.contains("å…¶ä»–") {
                        TextField("è«‹æè¿°é¡å¤–æœå‹™å…§å®¹", text: $extraServiceDetail, axis: .vertical)
                            .lineLimit(2...5)
                    }
                    
                    DatePicker("æ—¥æœŸèˆ‡æ™‚é–“", selection: $date, displayedComponents: [.date, .hourAndMinute])
                        .datePickerStyle(.compact)
                }
                
                // MARK: æ¶ˆè²»é‡‘é¡
                Section("æ¶ˆè²»é‡‘é¡ (å¿…å¡«)") {
                    HStack {
                        Text("$")
                            .foregroundColor(.secondary)
                        TextField("é‡‘é¡", text: $amountInput)
                            .keyboardType(.decimalPad)
                            .multilineTextAlignment(.trailing)
                    }
                }
                
                // MARK: å®¢æˆ¶è¯çµ¡è³‡è¨Š
                Section("å®¢æˆ¶è¯çµ¡è³‡è¨Š (é¸å¡«)") {
                    TextField("éƒµä»¶åœ°å€ (Email)", text: $email)
                        .keyboardType(.emailAddress)
                        .textInputAutocapitalization(.never)
                 
                    TextField("é›»è©±è™Ÿç¢¼ (Phone)", text: $phone)
                        .keyboardType(.phonePad)
                }
                
                // MARK: ç…§ç‰‡/è¨˜éŒ„å‚™è¨»
                Section("ç…§ç‰‡/è¨˜éŒ„å‚™è¨» (é¸å¡«)") {
                    TextEditor(text: $photoDescription)
                        .frame(height: 100)
                }
                
                // æäº¤æŒ‰éˆ•
                Button("å„²å­˜é ç´„ï¼Œä¸¦è¨­å®šæœ¬åœ°æé†’") {
                    saveAppointment()
                }
                .disabled(finalName.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty || amountInput.isEmpty)
                .frame(maxWidth: .infinity)
                .buttonStyle(.borderedProminent)
            }
            // ä¿®æ­£ï¼šnavigationTitle æ‡‰ç”¨æ–¼ NavigationView å…§éƒ¨çš„ View (Form)
            .navigationTitle("æ–°å¢é ç´„")
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("å–æ¶ˆ") {
                        dismiss()
                    }
                }
            }
            .alert("é ç´„åŒæ­¥ç‹€æ…‹", isPresented: $isShowingStatusAlert) {
                Button("ç¢ºå®š") {
                    self.dismiss()
                }
            } message: {
                Text(calendarStatusMessage ?? "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚")
            }
        }
    }
    
    /// å°‡æ–°é ç´„æ·»åŠ åˆ°åˆ—è¡¨ã€æ—¥æ›†ä¸¦è¨­å®šé€šçŸ¥
    func saveAppointment() {
        let parsedAmount = Double(amountInput.trimmingCharacters(in: .whitespacesAndNewlines))
        let trimmedPhotoDesc = photoDescription.trimmingCharacters(in: .whitespacesAndNewlines)
        
        let detail = service.contains("å…¶ä»–") ? extraServiceDetail.trimmingCharacters(in: .whitespacesAndNewlines) : ""
        let trimmedDetail = detail.isEmpty ? nil : detail
        
        let newAppointment = Appointment(
            name: finalName,
            date: date,
            service: service,
            email: email.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty ? nil : email,
            phone: phone.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty ? nil : phone,
            amount: parsedAmount,
            photoDescription: trimmedPhotoDesc.isEmpty ? nil : trimmedPhotoDesc,
            isPhotoAttached: false,
            extraServiceDetail: trimmedDetail
        )
        
        appointments.append(newAppointment)
        saveAction()
        
        scheduleLocalNotification(appointment: newAppointment)
        addEventToCalendar(appointment: newAppointment)
    }

    // MARK: - æœ¬åœ°é€šçŸ¥é‚è¼¯
    func scheduleLocalNotification(appointment: Appointment) {
        let center = UNUserNotificationCenter.current()
        guard let reminderDate = Calendar.current.date(byAdding: .minute, value: -30, to: appointment.date) else { return }
        guard reminderDate > Date() else { return }
        
        let content = UNMutableNotificationContent()
        content.title = "â° é ç´„æé†’ï¼šæœå‹™å°‡æ–¼ 30 åˆ†é˜å¾Œé–‹å§‹"
        content.body = "å®¢æˆ¶ï¼š\(appointment.name)ï¼›æœå‹™ï¼š\(appointment.service)ã€‚è«‹æº–æ™‚æº–å‚™ã€‚"
        content.sound = UNNotificationSound.default
        
        let triggerDateComponents = Calendar.current.dateComponents([.year, .month, .day, .hour, .minute], from: reminderDate)
        let trigger = UNCalendarNotificationTrigger(dateMatching: triggerDateComponents, repeats: false)
        let request = UNNotificationRequest(identifier: appointment.id.uuidString, content: content, trigger: trigger)
        
        center.add(request) { error in
            if let error = error { print("Error scheduling notification: \(error.localizedDescription)") }
        }
    }
    
    // MARK: - æ—¥æ›†åŒæ­¥é‚è¼¯
    func addEventToCalendar(appointment: Appointment) {
        eventStore.requestFullAccessToEvents { granted, error in
            DispatchQueue.main.async {
                if granted && error == nil {
                    let event = EKEvent(eventStore: self.eventStore)
                    event.title = "é ç´„: \(appointment.service) (\(appointment.name))"
                    event.startDate = appointment.date
                    event.endDate = Calendar.current.date(byAdding: .hour, value: 1, to: appointment.date)!
                    var notes = "æœå‹™é …ç›®: \(appointment.service)\né ç´„è€…: \(appointment.name)"
                    if let detail = appointment.extraServiceDetail { notes += "\né¡å¤–æœå‹™: \(detail)" }
                    // ä¿®æ­£ï¼šä¿®æ­£é‡‘é¡çš„å­—ä¸²æ ¼å¼
                    if let amount = appointment.amount { notes += "\næ¶ˆè²»é‡‘é¡: $\(String(format: "%.0f", amount))" }
                    if let photoDesc = appointment.photoDescription { notes += "\nç…§ç‰‡å‚™è¨»: \(photoDesc)" }
                    if let email = appointment.email { notes += "\néƒµä»¶: \(email)" }
                    if let phone = appointment.phone { notes += "\né›»è©±: \(phone)" }
                    if appointment.isPhotoAttached { notes += "\n [å·²é™„åŠ æœå‹™ç…§ç‰‡è¨˜éŒ„] " }
                    
                    event.notes = notes
                    event.calendar = self.eventStore.defaultCalendarForNewEvents
               
                    do {
                        try self.eventStore.save(event, span: .thisEvent)
                        self.calendarStatusMessage = "âœ… é ç´„å·²æˆåŠŸæ–°å¢è‡³æ—¥æ›†èˆ‡æœ¬åœ°é€šçŸ¥ï¼"
                        self.isShowingStatusAlert = true
                    } catch {
                        self.calendarStatusMessage = "âŒ æ—¥æ›†å„²å­˜å¤±æ•—: \(error.localizedDescription)"
                        self.isShowingStatusAlert = true
                    }
                } else {
                    let errorMessage = error?.localizedDescription ?? "æ—¥æ›†æ¬Šé™è¢«æ‹’ã€‚è«‹åœ¨è¨­å®šä¸­é–‹å•Ÿã€‚"
                    self.calendarStatusMessage = "âš ï¸ é ç´„å·²å„²å­˜ï¼Œä½†æ—¥æ›†åŒæ­¥å¤±æ•—ã€‚\nåŸå› : \(errorMessage)"
                    self.isShowingStatusAlert = true
                }
            }
        }
    }
}


// MARK: - ä¸»å…§å®¹è¦–åœ– (Main Tab View Wrapper)

/// ä¸»å…§å®¹è¦–åœ–
struct ContentView: View {
    @State private var appointments: [Appointment] = []
    @State private var members: [Member] = []
    @State private var generalTransactions: [GeneralTransaction] = [] // æ–°å¢ï¼šæ—¥å¸¸äº¤æ˜“
    
    
    private let appointmentKey = "StoredAppointments"
    private let memberKey = "StoredMembers"
    private let transactionKey = "StoredGeneralTransactions" // æ—¥å¸¸äº¤æ˜“å„²å­˜éµ
    
    init() {
        _appointments = State(initialValue: loadAppointments())
        _members = State(initialValue: loadMembers())
        _generalTransactions = State(initialValue: loadTransactions()) // è¼‰å…¥äº¤æ˜“
        requestNotificationPermission()
    }
    
    func requestNotificationPermission() {
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
            if granted {
                print("Notification permission granted.")
            } else if let error = error {
                print("Notification permission error: \(error.localizedDescription)")
            } else {
                print("Notification permission denied.")
            }
        }
    }
    var body: some View {
        TabView {
            // MARK: Tab 1: é ç´„åˆ—è¡¨
            AppointmentListView(
                appointments: $appointments,
                members: members,
                saveAction: saveAppointments,
                deleteAction: deleteAppointments
            )
            .tabItem {
                Label("é ç´„åˆ—è¡¨", systemImage: "list.bullet.clipboard")
            }
            
            // MARK: Tab 2: é ç´„æ­·å²
            HistoryView(appointments: appointments)
                .tabItem {
                    Label("é ç´„æ­·å²", systemImage: "clock.fill")
                }
            
            // MARK: Tab 3: æ”¶å…¥/æ”¯å‡º (æ–°å¢)
            IncomeExpenseView(
                appointments: appointments,
                generalTransactions: $generalTransactions,
                members: members,
                saveAction: saveTransactions
            )
            .tabItem {
                Label("æ”¶å…¥/æ”¯å‡º", systemImage: "dollarsign.circle.fill")
                
            }
            
            // MARK: Tab 4: æ”¯å‡ºå ±å‘Š
            ReportView(
                appointments: appointments,
                generalTransactions: generalTransactions,
                members: members
            )
            .tabItem {
                Label("æ”¯å‡ºå ±å‘Š", systemImage: "chart.bar.fill")
            }
            
            // MARK: Tab 5: æˆå“¡ç®¡ç†
            MemberManagementView(members: $members, saveAction: saveMembers)
                .tabItem {
                    Label("æˆå“¡ç®¡ç†", systemImage: "person.3.fill")
                }
        }
        .tint(.indigo)
    }
    
    // MARK: - è³‡æ–™æŒä¹…åŒ–é‚è¼¯
    
    func loadAppointments() -> [Appointment] {
        if let savedData = UserDefaults.standard.data(forKey: appointmentKey) {
            if let decodedAppointments = try? JSONDecoder().decode([Appointment].self, from: savedData) {
                return decodedAppointments
            }
        }
        return []
    }
    
    func saveAppointments() {
        if let encoded = try? JSONEncoder().encode(appointments) {
            UserDefaults.standard.set(encoded, forKey: appointmentKey)
        }
    }
    
    func deleteAppointments(at offsets: IndexSet) {
        let sortedAppointments = appointments.sorted(by: { $0.date < $1.date })
        let appointmentsToDelete = offsets.map { sortedAppointments[$0] }
        
        for appointment in appointmentsToDelete {
            if let index = appointments.firstIndex(where: { $0.id == appointment.id }) {
                UNUserNotificationCenter.current().removePendingNotificationRequests(withIdentifiers: [appointment.id.uuidString])
                
                appointments.remove(at: index)
            }
        }
        saveAppointments()
    }
    
    func loadMembers() -> [Member] {
        if let savedData = UserDefaults.standard.data(forKey: memberKey) {
            if let decodedMembers = try? JSONDecoder().decode([Member].self, from: savedData) {
                return decodedMembers.sorted { $0.name < $1.name }
            }
        }
        return []
    }

    func saveMembers() {
        if let encoded = try? JSONEncoder().encode(members) {
            UserDefaults.standard.set(encoded, forKey: memberKey)
        }
    }
    
    func loadTransactions() -> [GeneralTransaction] {
        if let savedData = UserDefaults.standard.data(forKey: transactionKey) {
            if let decodedTransactions = try? JSONDecoder().decode([GeneralTransaction].self, from: savedData) {
                return decodedTransactions
            }
        }
        return []
    }
    
    func saveTransactions() {
        if let encoded = try? JSONEncoder().encode(generalTransactions) {
            UserDefaults.standard.set(encoded, forKey: transactionKey)
        }
    }
}

// MARK: - 9. App çµæ§‹ (App Structure)

/// App çµæ§‹
@main
struct AppointmentSystemApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}
